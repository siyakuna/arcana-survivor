<!doctype html>
<html lang="jp">
  <head>
    <meta charset="utf-8" />
    <title>アルカナサバイバー</title>
    <style>
      * {
        padding: 0;
        margin: 0;
       
      }
      canvas {
        background: #eee;
        display: block;
  width: 99%;
  height: 99%;
  margin: 0;
  padding: 0;
      }
    </style>
  </head>
  <head prefix="og: https://ogp.me/ns#">
    <meta property="og:title" content="アルカナサバイバー" />
    <meta property="og:description" content="PCでできるブラウザゲームになったぞ！" />
    <meta property="og:image" content="" />
</head>
  <body>
    <canvas id="myCanvas" width="1920" height="1080" ></canvas>

    <script>
      // JavaScript のコードはここ
    const canvas = document.getElementById("myCanvas");
    const ctx = canvas.getContext("2d");
    const chara = new Image();
    const enemyCharaR = new Image();
    const enemyCharaL = new Image();
    const backgroundimg = new Image();
    const potion = new Image();
    const potionArea = new Image();
    potion.src = "potion.png"
    backgroundimg.src = "haikei.png"
    chara.src = "antaresu.png"
    potionArea.src = "poisonArea.png"
    let selctChara = "antaresu";//初期キャラ
    let x = 900;
    let y = 500;
    let dx = 0;
    let dy = 0;
    let dxRemove = 0.94;
    let dyRemove = 0.94;
    var yStop = true;
    var xStop = true;
    var hanten = 1;
    let enemyXY = [];
    let potionXY = [];
    let enemySizeX = 50;
    let enemySizeY =  110;
    let weapon = [];
    let poisonAreaXY = [];
    let potionMaxCoolTime = 700;
    let potionCoolTime = 700;
    var rota = 0;
    var maxHp = 1;
    var hp = 1;
    var stopEnemy = false;
    var timer = 0;
    var Ftimer = 0;
    var mp = 30;
    enemyCharaR.src = "enemy-r.png"
    enemyCharaL.src = "enemy-l.png"
      if(selctChara = "antaresu"){//キャラ選択結果
        chara.src = "antaresu.png";
        maxHp = 500;
        hp = maxHp;
        var charaSizeX = 48;
        var charaSizeY = 110;
      }
      OneSkil()

    function syori() {
          //枠の判定
    if(x <= 0){//左
      x = 1;
      dx = 0;
    } 
    if(y <= 170){//上
      y = 171;
      dy =0;
    }
    if(x + 48 >= 1920){//右
      x = 1871;
      dx = 0;
    }
    if(y + 110 >= 1080){
      y = 969;
      dy = 0;
    }
    x += dx;
    y += dy;
    if(yStop) dy = dy * dyRemove;
    if(xStop) dx = dx * dxRemove;
    
    if(Ftimer >= 100){
      Ftimer = 0
      timer++;
      if(timer % 3 === 0 )enemy(2);
      if(mp < 30)mp++;
    }else{//マイフレーム処理
      Ftimer++;
      potionCoolTime += -1
    }

    //武器処理
    potionkyodou()
    //武器発動
    weaponSyori()
    for (let i = 0; i < Object.keys(enemyXY).length; i++) {//敵の動き
      var enemyInfo = enemyXY[i];
      var eDx = x - enemyInfo[0];
      var eDy = y - enemyInfo[1];
      var s = 0.3 * enemyInfo[2].boost;//スピード
      var d = Math.sqrt((x - enemyInfo[0]) ** 2 + (y - enemyInfo[1]) ** 2);
      var t = d / s;
      var vx = eDx / t;
      var vy = eDy / t;
      if((stopEnemy)){//ヒプノーシス発動時
        enemyInfo[2].count  = 5 * 100;
        enemyInfo[2].boost  = 0;
      }
      if(enemyInfo[2].count  < 0){
        enemyInfo[2].boost  = 1;
      }else{
        enemyInfo[2].count += -1;
        enemyInfo[2].boost  = 0;
      }
      enemyInfo[0] += vx;
      enemyInfo[1] += vy;
      if(vx < 0){
        enemyInfo[2].rl = "r"
      }else{
        enemyInfo[2].rl = "l"
      }
      //pcとの衝突判定
      if((enemyInfo[0] < x + charaSizeX)&&(enemyInfo[1] < y + charaSizeY)){//左上から
        if((enemyInfo[0] + enemySizeX > x)&&(enemyInfo[1] + enemySizeY > y)){//右下から
          hp += -1;
        }
      }
    }
    stopEnemy = false;
    }
    function enemy(n){//敵配置
      for(let i = 0; i < n; i++){
        var hen = Math.floor(Math.random() * 3)
      if(hen === 0)enemyXY.push([-10, Math.floor(Math.random() * 910) + 170, {hp: 100, boost: 1,count: 0,rl: "r"}])//左
      if(hen === 1)enemyXY.push([1930, Math.floor(Math.random() * 910) + 170, {hp: 100, boost: 1,count: 0,rl: "r"}])//右
//      if(hen === 2)enemyXY.push([Math.floor(Math.random() * 1920), -10, {HP: 10, boost: 1,count: 0}])//上
      if(hen === 2)enemyXY.push([Math.floor(Math.random() * 1920), 1090, {hp: 100, boost: 1,count: 0,rl: "r"}])//下
      }
    }
//PC能力
    function OneSkil(){
      if(selctChara = "antaresu"){
        weapon.push('potion');
      }
    }
    function weaponSyori(){
      if(weapon.includes('potion')){
        if(potionCoolTime <= 0){
      potionCoolTime = potionMaxCoolTime;
        var potionDrop = Math.floor(Math.random() * Object.keys(enemyXY).length)
        var enemyInfo = enemyXY[potionDrop];
        var koukazikann = 5;
        potionXY.push([x, y, enemyInfo[0], enemyInfo[1], koukazikann, 500]);
        console.log('ok')
      }}
    }
    function potionkyodou(){
      for (let i = 0; i < Object.keys(potionXY).length; i++) {
      var potionInfo = potionXY[i]
      var eDx =  potionInfo[2] - potionInfo[0];
      var eDy =  potionInfo[3] - potionInfo[1];
      var s = 8;//スピード
      var d = Math.sqrt((potionInfo[2] - potionInfo[0]) ** 2 + (potionInfo[3] - potionInfo[1]) ** 2);
      var t = d / s;
      var vx = eDx / t;
      var vy = eDy / t;
      potionInfo[0] += vx;
      potionInfo[1] += vy;
      if(potionInfo[5] = 500){
        potionInfo[5] = t;
      }else{
        potionInfo[5] += -1;
      }
      if(potionInfo[5] < 1){
        potionDamage(potionInfo[0], potionInfo[1])
        potionXY.splice(i, 1);
      }
    }
    for (let i = 0; i < Object.keys(poisonAreaXY).length; i++) {//ダージエリア処理
      var areaInfo = poisonAreaXY[i];
      if(Ftimer === 0){
        areaInfo[2] += -1;
      }
      if(areaInfo[2] <= 0)poisonAreaXY.splice(i, 1)
        for (let ei = 0; ei < Object.keys(enemyXY).length; ei++) {//敵に触れると
        var enemyInfo = enemyXY[ei];
        if((enemyInfo[0] < areaInfo[0] + 80)&&(enemyInfo[1] < areaInfo[1] + 80)){//左上から
        if((enemyInfo[0] + enemySizeX > areaInfo[0])&&(enemyInfo[1] + enemySizeY > areaInfo[1])){//右下から
          console.log('当たった')
       enemyInfo[2].hp += -2;
        }
      }
        }
        }
    }
    function  potionDamage(px,  py){//ポーションのエリア生成
      poisonAreaXY.push([px, py, 4])
    }
    function skill(){
      if(selctChara = "antaresu"){
        stopEnemy = true;
        var enemySizeTime = 5;
      }
    }
    function weaponDraw(){//武器描写
      if(weapon.includes('potion')){
      for (let i = 0; i < Object.keys(potionXY).length; i++) {
      rota += 0.0005
      var potionInfo = potionXY[i]
      ctx.save();
      ctx.translate(potionInfo[0] + 40, potionInfo[1] + 30);
      ctx.rotate(180 * rota);
      ctx.drawImage(potion, 0, 0, 40, 40);
      ctx.restore();
    }  
  }
    }

      function draw() {//描写
        if(hp < 0)return
    syori();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.drawImage(backgroundimg, 0, 0, 1920, 1080);
    for (let i = 0; i < Object.keys(poisonAreaXY).length; i++) {
      var areaInfo = poisonAreaXY[i];
      ctx.drawImage(potionArea, areaInfo[0], areaInfo[1], 80, 80);
    }
    for (let i = 0; i < Object.keys(enemyXY).length; i++) {
      var enemyInfo = enemyXY[i]
    //  console.log(enemyInfo[0])
    ctx.font = "20px serif";
    if(enemyInfo[2].rl === "r"){
      ctx.drawImage(enemyCharaR, enemyInfo[0], enemyInfo[1], enemySizeX, enemySizeY);
    }else{
      ctx.drawImage(enemyCharaL, enemyInfo[0], enemyInfo[1], enemySizeX, enemySizeY);
    }
//    ctx.strokeText(`HP:${enemyInfo[2].hp}`, enemyInfo[0], enemyInfo[1]);//敵体力表示
    }  
    ctx.drawImage(chara, x, y, charaSizeX, charaSizeY);
    weaponDraw()
  //体力バー
if(hp > 0){    ctx.fillStyle = "red";
    ctx.fillRect(x, y + charaSizeY + 10, charaSizeX, 10)
    ctx.fillStyle = "blue";
    var hpbar = hp / maxHp
    ctx.fillRect(x, y + charaSizeY + 10, charaSizeX *  hpbar, 10);}
    ctx.font = "48px serif";
    ctx.strokeText(`timer:${timer}スタミナ:${mp}`, 10, 50);
    
    ctx.closePath();


    for (let i = 0; i < Object.keys(enemyXY).length; i++) {//敵の死亡
      var enemyInfo = enemyXY[i];
    if(enemyInfo[2].hp < 0){
      enemyXY.splice(i, 1);
      console.log('死亡')
      }}
}
document.addEventListener('keydown', event => {
  if(hp < 0)return
    if (event.code === 'KeyW') {
        yStop = false;
        dy = -1.5;
    }
    if (event.code === 'KeyS') {
        yStop = false;
        dy = 1.5;
    }
    if (event.code === 'KeyA') {
      chara.src = "antaresu-l.png"
        xStop = false;
        dx = -1.5;
        hanten = -1;
    }
    if (event.code === 'KeyD') {
      chara.src = "antaresu.png"
        xStop = false;
        dx = 1.5;
        hanten = 1;
    }
    if (event.code === 'Space') {
      if(mp < 30)return
      skill();
      mp = 0;
    }
});
document.addEventListener('keyup', event => {
    if (event.code === 'KeyW') {
        yStop = true
    }
    if (event.code === 'KeyS') {
        yStop = true
    }
    if (event.code === 'KeyA') {
        xStop = true
    }
    if (event.code === 'KeyD') {
        xStop = true
    }
});
enemy(10)
setInterval(draw, 10);
    </script>
  </body>
</html>
